# azure-func-middleware

[![Build Status](https://travis-ci.com/safer-bwd/azure-func-middleware.svg?branch=master)](https://travis-ci.com/safer-bwd/azure-func-middleware)

Middleware cascade implementation for Azure Functions JS 2.x (inspired by Koa and Express).

## Install

```sh
npm install azure-func-middleware --save
```

## Usage

#### Main flow

index.js

```javascript
const AzureFuncMiddleware = require('azure-func-middleware');

module.exports = new AzureFuncMiddleware()
  .use(async (ctx, next) => {
    // will be called first
    // ...
    next();
  })
  .use((ctx, next) => {
    // will be called second if no error in first fn
    // ...
    ctx.done(null, { status: 200 });
  })
  .catch((err, ctx, next) => {
    // will be called if there is error in first or second fn
    // ...
    ctx.done(null, { status: 500 });
  })
  .listen();
```

## Testing

The handler that creates **azure-func-middleware** returns a promise. This fact can be used for testing.

#### Using with the `$return` output binding

function.json

```
{
  "bindings": [
    ...
    {
    "type": "http",
    "direction": "out",
    "name": "$return"
    }
  ]
}
```

test.js

```javascript
const funcHandler = require('...');

it('should work', async () => {
  const context = { ... };
  const expectedBody = ...;
  const { status, body } = await funcHandler(context);
  expect(status).toEqual(200);
  expect(body).toEqual(expectedBody);
});
```

#### Using with the named output binding

function.json

```
{
  "bindings": [
    ...
    {
    "type": "http",
    "direction": "out",
    "name": "response"
    }
  ]
}
```

test.js

```javascript
const funcHandler = require('...');

it('should work', async () => {
  const context = { ... };
  const expectedBody = ...;
  await funcHandler(context);
  expect(context.res.status).toEqual(200);
  expect(context.res.body).toEqual(expectedBody);
});
```

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [AzureFuncMiddleware](#azurefuncmiddleware)
    -   [Parameters](#parameters)
    -   [use](#use)
        -   [Parameters](#parameters-1)
    -   [useIf](#useif)
        -   [Parameters](#parameters-2)
    -   [catch](#catch)
        -   [Parameters](#parameters-3)
    -   [useMany](#usemany)
        -   [Parameters](#parameters-4)
    -   [listen](#listen)
-   [middleware](#middleware)
    -   [Properties](#properties)
-   [middlewareFunction](#middlewarefunction)
    -   [Parameters](#parameters-5)
-   [middlewareErrorFunction](#middlewareerrorfunction)
    -   [Parameters](#parameters-6)
-   [nextFunction](#nextfunction)
    -   [Parameters](#parameters-7)
-   [predicateFunction](#predicatefunction)
    -   [Parameters](#parameters-8)

### AzureFuncMiddleware

#### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**  (optional, default `{}`)
    -   `options.silent` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**  (optional, default `false`)

#### use

Add a middleware to a cascade

##### Parameters

-   `fn` **[middlewareFunction](#middlewarefunction)** 

#### useIf

Add a middleware with condition to a cascade

##### Parameters

-   `predicate` **[predicateFunction](#predicatefunction)** 
-   `fn` **[middlewareFunction](#middlewarefunction)** 

#### catch

Add a middleware for error handling to a cascade

##### Parameters

-   `fn` **[middlewareErrorFunction](#middlewareerrorfunction)** 

#### useMany

Add several middlewares to a cascade

##### Parameters

-   `middlewares` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;([middleware](#middleware) \| [middlewareFunction](#middlewarefunction))>** 

#### listen

Compose middlewares to a handler

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

### middleware

Type: [Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)

#### Properties

-   `fn` **([middlewareFunction](#middlewarefunction) \| [middlewareErrorFunction](#middlewareerrorfunction))** 
-   `isError` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)?** 
-   `predicate` **[predicateFunction](#predicatefunction)?** 

### middlewareFunction

Type: [Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)

#### Parameters

-   `context` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** [The context object](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-node#context-object)
-   `next` **[nextFunction](#nextfunction)** 

### middlewareErrorFunction

Type: [Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)

#### Parameters

-   `error` **[Error](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error)** 
-   `context` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** [The context object](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-node#context-object)
-   `next` **[nextFunction](#nextfunction)** 

### nextFunction

Type: [Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)

#### Parameters

-   `error` **[Error](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error)?** 

### predicateFunction

Type: [Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)

#### Parameters

-   `context` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)?** [The context object](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-node#context-object)

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 
